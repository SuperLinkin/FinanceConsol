# System Settings - User Management Guide

## Overview

The System Settings feature provides comprehensive user management and access control for your financial consolidation platform. Only users with **Administrator** or **Primary Admin** roles can access this feature.

---

## Accessing System Settings

1. Click on your **user profile icon** in the top-right corner
2. Select **System Settings** from the dropdown menu (only visible to admins)
3. You'll be redirected to the System Settings page

**Note**: If you don't see "System Settings" in the dropdown, you don't have admin access.

---

## User Roles & Permissions

### Role Hierarchy

The platform supports 5 distinct roles with hierarchical permissions:

| Role | Level | Description | Capabilities |
|------|-------|-------------|--------------|
| **Primary Admin** | 5 | Company owner | Full system access, cannot be modified by others |
| **Administrator** | 4 | System administrator | Can manage users and all settings (except primary admin) |
| **Manager** | 3 | Department manager | Can manage data, run reports, view analytics |
| **User** | 2 | Standard user | Can view and edit assigned data |
| **Viewer** | 1 | Read-only access | Can only view data, no editing rights |

### Role Restrictions

**Primary Admin**:
- âœ… Cannot be deleted
- âœ… Cannot be deactivated
- âœ… Cannot have role changed by other users
- âœ… Only one primary admin per company
- âœ… Can only be modified by themselves

**Administrator**:
- âœ… Can manage all users except primary admin
- âœ… Can invite new users
- âœ… Can change user roles (except to/from primary admin)
- âœ… Can activate/deactivate users
- âœ… Can delete users (except primary admin and themselves)

**All Users**:
- âŒ Cannot change their own role
- âŒ Cannot delete their own account
- âŒ Cannot deactivate their own account

---

## System Settings Tabs

### 1. User Management

View and manage all users in your company.

#### Features:

**Search & Filter**
- ğŸ” Search by name, email, or username
- ğŸ¯ Filter by role (All Roles, Admin, Manager, User, Viewer)

**User Table Columns**:
- **User**: Name, username, and avatar
- **Email**: Email address with verification status
- **Role**: Color-coded role badge
- **Status**: Active/Inactive indicator
- **Last Login**: Most recent login date
- **Actions**: Edit, Activate/Deactivate, Delete buttons

**Action Buttons**:
- âœï¸ **Edit**: Modify user details and role
- ğŸ”’ **Lock/Unlock**: Activate or deactivate user account
- ğŸ—‘ï¸ **Delete**: Permanently remove user (with confirmation)
- â• **Invite User**: Send invitation to new user

---

### 2. Roles & Permissions

View detailed information about each role and their capabilities.

**Displays**:
- Role name and color coding
- Role description
- Permission level
- Security notes and restrictions

**Important Notes Shown**:
- Primary Admin protection
- User management permissions
- Self-modification restrictions
- Account lockout policy

---

### 3. Company Settings

Manage company-level configuration (Primary Admin only).

**Editable Fields** (Primary Admin):
- Company Name
- Subscription Tier (Basic, Professional, Enterprise)

**Read-Only Fields**:
- Company Slug (unique identifier)
- Subscription Status
- Created Date

**Note**: Only Primary Admin can edit company settings. Administrators can view but not modify.

---

## User Management Operations

### Inviting a New User

1. Click **"Invite User"** button
2. Fill in the invitation form:
   - **Email** (required): User's email address
   - **First Name** (required)
   - **Last Name** (required)
   - **Role** (required): Select from Admin, Manager, User, or Viewer

3. Click **"Send Invitation"**

**What Happens**:
- âœ… User account is created immediately
- âœ… Username is auto-generated from email
- âœ… Temporary password is generated
- âœ… Invitation record is created (valid for 7 days)
- âœ… User marked as "Not Verified" until first login

**Credentials**:
After invitation, you'll receive the temporary credentials in the success modal:
```
Username: autogenerated_username
Password: TemporaryPassword123
```

**Important**:
- Save these credentials securely
- Share them with the user via secure channel (not email)
- User will be prompted to change password on first login
- If username is taken, a number is appended (e.g., johndoe1, johndoe2)

---

### Editing a User

1. Click the **Edit (âœï¸)** button next to a user
2. Modify the fields:
   - First Name
   - Last Name
   - Role (if you have permission)
   - Status (Active/Inactive)

3. Click **"Update User"**

**Restrictions**:
- âŒ Cannot edit Primary Admin (unless you are the primary admin)
- âŒ Cannot change your own role
- âŒ Non-primary admins cannot assign Primary Admin role

**Audit Trail**:
All user edits are logged in the audit_log table for compliance.

---

### Activating/Deactivating Users

**To Toggle Status**:
1. Click the **Lock/Unlock (ğŸ”’/ğŸ”“)** button
2. Confirm the action

**When Deactivating**:
- âŒ User cannot login
- âŒ All active sessions are terminated immediately
- âœ… User data is preserved
- âœ… Can be reactivated anytime

**Restrictions**:
- âŒ Cannot deactivate Primary Admin
- âŒ Cannot deactivate yourself
- âœ… Only Admins can activate/deactivate users

---

### Deleting a User

**Warning**: This action is **permanent** and cannot be undone.

**To Delete**:
1. Click the **Delete (ğŸ—‘ï¸)** button
2. Confirm the deletion when prompted

**What Gets Deleted**:
- âœ… User account
- âœ… All user sessions
- âœ… User invitations

**What's Preserved**:
- âœ… Audit logs (for compliance)
- âœ… Data created by the user (with user_id reference)

**Restrictions**:
- âŒ Cannot delete Primary Admin
- âŒ Cannot delete yourself
- âŒ Cannot delete if user owns critical data (future feature)

**Best Practice**:
Deactivate users instead of deleting them to maintain audit trails.

---

## Security Features

### Account Protection

**Failed Login Attempts**:
- ğŸ”’ Account locks after 5 failed login attempts
- â° Lockout lasts 30 minutes
- ğŸ”“ Auto-unlocks after timeout
- ğŸ“ All attempts logged in audit_log

**Session Management**:
- â±ï¸ Sessions expire after 7 days
- ğŸ”„ Auto-renewed on activity
- ğŸšª Logout terminates session immediately
- ğŸ”’ Deactivating user kills all sessions

**Password Requirements**:
- Minimum 8 characters (enforced at login)
- Hashed with bcryptjs (10 salt rounds)
- Temporary passwords are 24 characters (auto-generated)

### Audit Logging

All administrative actions are logged:
- âœ… User invitations
- âœ… User updates (role changes, status changes)
- âœ… User deletions
- âœ… User activation/deactivation
- âœ… Company settings changes

**Audit Log Fields**:
- Who (user_id of admin)
- What (action type)
- When (timestamp)
- Details (JSON payload of changes)
- Resource (user_id of affected user)

---

## API Endpoints

The System Settings feature uses these API endpoints:

### User Management
```
GET    /api/users              - List all users
POST   /api/users/invite       - Invite new user
PUT    /api/users/[userId]     - Update user
DELETE /api/users/[userId]     - Delete user
PATCH  /api/users/[userId]/status - Toggle user status
```

### Company Settings
```
GET /api/company/settings    - Get company settings
PUT /api/company/settings    - Update company settings (primary admin only)
```

### Authentication
All endpoints require:
- Valid session token in cookies
- Admin or Primary Admin role
- Company ID match (multi-tenant isolation)

---

## Troubleshooting

### "Unauthorized - Admin access required"

**Cause**: Your account doesn't have admin permissions.

**Solution**:
- Check your role in the user dropdown (top-right)
- Contact your Primary Admin to upgrade your role

---

### "Cannot modify primary admin"

**Cause**: Trying to edit/delete the primary admin account.

**Solution**:
- Primary admin can only be modified by themselves
- Use a different admin account, or
- Login as the primary admin

---

### "A user with this email already exists"

**Cause**: Email address is already in use in your company.

**Solution**:
- Check the user list - they may already have an account
- Use a different email address
- If the user is inactive, reactivate instead of creating new

---

### User invitation sent but user can't login

**Possible Causes**:
1. User is using wrong username/password
2. User account is deactivated
3. User is locked due to failed attempts

**Solutions**:
1. Verify credentials from invitation response
2. Check user status in user table
3. Check user's `locked_until` field and wait for unlock
4. Reset user password by editing user

---

### "Invalid session" errors

**Cause**: Session expired or invalid.

**Solution**:
- Logout and login again
- Check JWT_SECRET is set in environment
- Verify session_token cookie is present

---

## Best Practices

### User Onboarding

1. âœ… **Invite with appropriate role** - Don't give everyone admin access
2. âœ… **Share credentials securely** - Use password managers or secure messaging
3. âœ… **Verify user logs in** - Check Last Login column
4. âœ… **Monitor failed attempts** - Check audit logs regularly

### Role Assignment

1. âœ… **Follow principle of least privilege** - Start with Viewer, upgrade as needed
2. âœ… **Limit admin accounts** - Only give admin to trusted users
3. âœ… **Review roles quarterly** - Remove access for departing employees
4. âœ… **Document role decisions** - Keep track of why users have certain roles

### Account Hygiene

1. âœ… **Deactivate instead of delete** - Preserve audit trail
2. âœ… **Review inactive users** - Deactivate accounts not used in 90 days
3. âœ… **Monitor last login** - Identify unused accounts
4. âœ… **Clean up test accounts** - Remove development/test users in production

### Security Monitoring

1. âœ… **Review audit logs** - Check for suspicious activity weekly
2. âœ… **Monitor failed logins** - Investigate repeated failures
3. âœ… **Track role changes** - Ensure they're legitimate
4. âœ… **Verify new users** - Confirm all invitations are authorized

---

## Keyboard Shortcuts

Currently no keyboard shortcuts are implemented, but coming soon:
- `Ctrl+K` - Quick search users
- `Ctrl+I` - Invite user modal
- `Esc` - Close modal

---

## Mobile Responsiveness

The System Settings page is fully responsive:
- ğŸ“± **Mobile**: Stacked layout, hamburger menu
- ğŸ’» **Tablet**: 2-column grid
- ğŸ–¥ï¸ **Desktop**: Full table view

---

## Future Enhancements

Planned features for future releases:

1. **Bulk User Import** - CSV upload for multiple users
2. **Email Integration** - Automatic invitation emails with magic links
3. **2FA Support** - Two-factor authentication for admins
4. **Role Templates** - Pre-defined permission sets
5. **User Groups** - Organize users by department/team
6. **Advanced Permissions** - Granular feature-level permissions
7. **Activity Dashboard** - User activity analytics
8. **Password Reset Flow** - Self-service password reset
9. **User Export** - Download user list as CSV
10. **API Key Management** - Generate API keys for integrations

---

## Support

If you encounter issues with System Settings:

1. **Check this guide** - Most common issues are covered here
2. **Review deployment guide** - `/docs/DEPLOYMENT_GUIDE.md`
3. **Check audit logs** - Look for error details
4. **Contact support** - Provide user ID and error message

---

## Technical Details

### Database Tables Used

**users**:
- User accounts and authentication
- Role assignments
- Status tracking

**user_sessions**:
- Active sessions
- Session expiry
- Environment (production/sandbox)

**user_invitations**:
- Pending invitations
- Invitation tokens
- Expiry tracking

**companies**:
- Company information
- Subscription status
- Settings

**audit_log**:
- All administrative actions
- Change history
- Compliance tracking

### RLS Policies

Row Level Security ensures:
- âœ… Users only see their company's data
- âœ… Admins can't access other companies
- âœ… Multi-tenant isolation is enforced
- âœ… Session-based access control

### Role-Based Access Control (RBAC)

Implemented at multiple levels:
1. **UI Level** - Hide/show features based on role
2. **API Level** - Verify role before executing actions
3. **Database Level** - RLS policies enforce isolation
4. **Middleware Level** - Route protection by role

---

**Last Updated**: Current session
**Version**: 1.0
**Maintained By**: Development Team
